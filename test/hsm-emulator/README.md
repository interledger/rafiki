# HSM Emulator
The `hsm-emulator` is a lightweight emulator that simulates the behavior of a Hardware Security Module (HSM) for
development and testing purposes.

## Overview
The HSM Emulator provides cryptographic operations such as key management between card and processor parties, enabling
developers to validate HSM-integrated workflows without requiring access to a physical HSM.

## Parties
The parties involved in the HSM emulator include:
- **ILF** - The ILF will be the activing ASE (Accont Serving Entity)
- **KaiOS** - The POS manufacturer
- **Austria Card** - The card issuer

## Build HSM Emulator:
The project is built as part of the Rafiki project.

## Start HSM Emulator
```shell
# Run (port 5002 default):
pnpm dev
```

## Key Management between Parties
The steps and digrams below illustrate the cryptographic keys and their relationship with one another and parties.

### 1.1. ZMK - Zone Master Key
The ZMK may be generated by either of two or more parties. One party is responsible for a ZMK key generation, while the 
other party is responsible for importing the ZMK. It is strongly advised that the ZMK be generated/imported using an HSM.
The KCV is used to verify integrity during the exchange. 

```mermaid
---
title: ZMK Exchange
---
erDiagram
    "ILF ğŸ¦" ||--}| "ZMK ğŸ”‘" : generates
    "KaiOS ğŸ“±" ||--|| "ZMK ğŸ”‘" : "imports (3x clear components)"
    "Austria Card ğŸ’³" ||--|| "ZMK ğŸ”‘" : "imports (3x clear components)"
```

### 1.2. TMK - Terminal Master Key
The Terminal Master Key (TMK) is generated by the POS or terminal manufacturer and is unique to each terminal. 
It is securely transferred to the Account Serving Entity (ASE), 
encrypted under the Zone Master Key (ZMK) using the TR-31 key block format. 
The TMK facilitates the secure delivery of session keys between the ASE and the terminal, 
ensuring encrypted communication and key management.

```mermaid
---
title: TMK Exchange
---
erDiagram
    "KaiOS ğŸ“±" ||--}| "TMK ğŸ”‘" : generates
    "ILF ğŸ¦" ||--}| "TMK ğŸ”‘" : "imports (under ZMK)"
```

### 1.3. PIN/SRED BDK and IPEK - Base Derivation Key and Initial PIN Encryption Keys
The Base Derivation Keys (BDKs) are generated by the Account Serving Entity (ASE) and typically remain consistent for each terminal 
manufacturer or model. From the BDK, Initial PIN Encryption Keys (IPEKs) are derived and securely loaded onto the terminal, 
encrypted under the Terminal Master Key (TMK) using the TR-31 key block format. 
This process ensures secure delivery of keys to the terminal, either through direct injection or via an over-the-air Remote Key Injection (RKI) mechanism.

```mermaid
---
title: PIN/SRED Key Exchange and IPEK
---
erDiagram
    "ILF ğŸ¦" ||--|| "SRED/PIN BDK ğŸ”‘" : "generates"
    "SRED/PIN BDK ğŸ”‘" ||--}| "IPEK ğŸ”‘" : "generates (based on BDK)"
    "Terminal ğŸ“±" ||--|| "IPEK ğŸ”‘" : "imports (under TMK)"
```

### 2.1 Card Key - Card Asymmetric Keys
The Card Key Pair is generated by the Account Serving Entity (ASE), which also acts as the issuer. 
A unique key pair is created for each card. 
The private key from this pair is securely linked to a corresponding wallet address.

```mermaid
---
title: Card Key Generation and Issuing
---
erDiagram
    "ILF ğŸ¦" ||--}| "Card KeyPair ğŸ”" : "generates"
    "Card KeyPair ğŸ”" ||--}| "Private Key ğŸ”‘" : "has"
    "Card KeyPair ğŸ”" ||--}| "Public Key ğŸ”“" : "has"
    "Public Key ğŸ”“" |{--}| "Wallet Address ğŸ“‡" : "ILF store against wallet address ğŸ’½"
    
    "Austria Card ğŸ’³" ||--}| "Private Key ğŸ”‘" : "imports (under ZMK)"

    "Private Key ğŸ”‘" ||--|| "Card ğŸ’³" : "loaded onto (securely during issuing)"
```

## Glossary of Terms
Terms of definition related to ASE, Card issuer and terminal manufacturers.

| Term        | Description                                                                                                                                                                                                                                                                 |
|-------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| HSM         | Hardware Security Module. Physical device that provides secure key storage and cryptographic processing. It is designed to protect sensitive data and perform secure operations.                                                                                            |
| LMK         | Local Master Key. Top-level encryption key used to secure and manage other keys within the HSM. It plays a central role in the HSMâ€™s key hierarchy.                                                                                                                         |
| ZMK         | Zone Master Key. Cryptographic key used to securely exchange other encryption keys between two systems or organizations â€” typically between two HSMs (Hardware Security Modules) that are part of different cryptographic zones.                                            |
| TMK         | Terminal Master Key. Used to secure the transmission of working keys (like PIN, SRED encryption keys or MAC keys) between a terminal and the HSM.                                                                                                                           |
| BDK         | Base Derivation Key, is the root key from which a unique IPEK (Initial PIN Encryption Key) is derived for each device or terminal. The IPEK, in turn, is used to derive session keys for each transaction, ensuring that no two transactions share the same encryption key. |
| IPEK        | Initial PIN Encryption Key, is used to derive session keys for each transaction, ensuring that no two transactions share the same encryption key.                                                                                                                           |
| KSN         | Key Serial Number. A unique identifier for each device, used in key derivation.                                                                                                                                                                                             |
| Session Key | Derived from the IPEK for encrypting a single transaction.                                                                                                                                                                                                                  |
| DUKPT       | DUKPT stands for Derived Unique Key Per Transaction. Itâ€™s a key management scheme used primarily in payment systems (e.g. POS terminals) to ensure each transaction is encrypted with a unique key, dramatically reducing the risk of compromise.                           |
| KCV         | Key Check Value. Short cryptographic value derived from a key, used to verify that the key has been correctly transferred or entered without revealing the key itself.                                                                                                      |
| POS         | Point of Service device (also referred to as the terminal).                                                                                                                                                                                                                 |
| TR-31       | A TR-31 key block is a standardized format used to securely exchange cryptographic keys between systems, especially in financial environments involving HSMs (Hardware Security Modules). It was defined by the ANSI X9.24-1 standard.                                      |
