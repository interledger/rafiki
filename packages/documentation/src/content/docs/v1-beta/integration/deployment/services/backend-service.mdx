---
title: Backend service
slug: v1-beta/integration/deployment/services/backend-service
---

import { LinkOut } from '@interledger/docs-design-system'
import Backend from '/src/partials/backend-variables.mdx'

Rafiki’s <LinkOut href="https://github.com/interledger/rafiki/tree/main/packages/backend">`backend`</LinkOut> service is the software’s main service for handling business logic and external communication. The service is responsible for:

- Exposing the endpoints of the [Open Payments APIs](#open-payments) for public clients to initiate payments and look up information. This is the external communication piece.
- Exposing an [Interledger connector](#interledger-connector) to send and receive STREAM packets with peers.
- Enabling you to manage accounts and track liquidity.
- Exposing an internal [GraphQL Backend Admin API](#graphql-backend-admin-api) for service operators to manage accounts, liquidity, and application settings, like peering relationships.

## Requirements

The following are required when using the `backend` service.

- A Redis database as a cache to share STREAM connection details and total amounts received across processes
- A Postgres database, separate from the `auth` service’s database, for Open Payments resources
- TigerBeetle or a separate Postgres database for accounting liquidity
  :::note
  You can use the same database instance of Postgres for the `backend` service, `auth` service, and accounting liquidity (if not using TigerBeetle). However, separate database schemas are required within the Rafiki instance to maintain boundaries between the managed objects.
  :::

You must also set the environment variables for the `backend` service.

## Open Payments

The `backend` service exposes the Open Payments APIs, which are auth-protected using an opinionated version of the Grant Negotiation and Authorization Protocol (GNAP). Review the [`auth`](/v1-beta/integration/deployment/services/auth-service) service page for more details about grant authorization and authentication.

The `backend` service allows you to manage Open Payments <LinkOut href="https://openpayments.dev/concepts/resources/#incoming-payment">incoming payments</LinkOut>, <LinkOut href="https://openpayments.dev/concepts/resources/#quote">quotes</LinkOut>, and <LinkOut href="https://openpayments.dev/concepts/resources/#outgoing-payment">outgoing payments</LinkOut>. Quotes and outgoing payments call the ILP connector, described in the next section, to send ILP packets. Quoting sends unfulfillable probe packets, for example to determine a transaction’s cost before executing the payment. Outgoing payments send packets as part of executing the payment.

## Interledger connector

The `backend` service exposes an ILP connector to send and receive ILP packets between peers.

Some of the responsibilities of a connector include:

- Authenticating packets against ILP account credentials.
- Forwarding packets to a sender or receiver.
- Rejecting a packet for any number of reasons, including expiration, insufficient liquidity, rate limit exceeded, or if the amount exceeds the `maxPacketAmount` [agreed to](/v1-beta/integration/requirements/peers#perform-prerequisites) by the connector and its peer.
- Converting currencies.
- Fulfilling packets with an internal STREAM server.

The `backend` service includes an HTTP server listening on the configured `CONNECTOR_PORT`. Your connector can receive incoming packets via HTTP and/or direct calls from within the `backend` service. An incoming packet is only accepted if it's from a configured peer and accompanied by your peer’s incoming HTTP `authToken`.

Similarly, if a packet's destination address corresponds to a peer, your connector forwards the packet to your peer over HTTP, along with your peer's outgoing HTTP `authToken`.

:::note[Auth tokens]
You and your peer should have exchanged incoming and outgoing auth tokens as part of establishing your [peering relationship](/v1-beta/integration/requirements/peers#perform-prerequisites).
:::

A packet can either continue on to your peer via HTTP or end at your Rafiki instance's STREAM server. If the packet terminates at your STREAM server, your connector attempts to extract and decode the payment tag from the packet's destination address. When your connector successfully matches the tag with a locally managed wallet address or incoming payment, the connector does not forward the packet. Instead, it credits the corresponding balance and track the total amount received in Redis to support STREAM receipts. Packets addressed to a wallet address happen via SPSP.

## GraphQL Backend Admin API

The `backend` service exposes a GraphQL [Backend Admin API](/v1-beta/apis/graphql/admin-api-overview#backend-admin-api) to manage assets, peers, wallet addresses, Open Payments resources, and several types of liquidity.

## Environment variables

### Required

<div class="overflow-table wider-column">

| Variable                        | Helm value name                                                                                                                                                       | Default                                                     | Description                                                                                                                 |
| ------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------- |
| `AUTH_SERVER_GRANT_URL`         | `backend.serviceUrls.AUTH_SERVER_GRANT_URL`                                                                                                                           | _undefined_                                                 | The endpoint on your Open Payments authorization server to grant a request.                                                 |
| `AUTH_SERVER_INTROSPECTION_URL` | `backend.serviceUrls.AUTH_SERVER_INTROSPECTION_URL`                                                                                                                   | _undefined_                                                 | The endpoint on your Open Payments authorization server to introspect an access token.                                      |
| `DATABASE_URL`                  | `backend.postgresql.host`,<br />`backend.postgresql.port`,<br />`backend.postgresql.username`,<br />`backend.postgresql.database`,<br />`backend.postgresql.password` | `postgresql://postgres:password@localhost:5432/development` | The Postgres database URL of the database storing your resource data. For Helm, these components are provided individually. |
| `EXCHANGE_RATES_URL`            | `backend.serviceUrls.EXCHANGE_RATES_URL`                                                                                                                              | _undefined_                                                 | The endpoint your Rafiki instance uses to request exchange rates.                                                           |
| `ILP_ADDRESS`                   | `backend.ilp.address`                                                                                                                                                 | _undefined_                                                 | The ILP address of your Rafiki instance.                                                                                    |
| `ILP_CONNECTOR_URL`             | `backend.ilp.connectorUrl`                                                                                                                                            | _undefined_                                                 | The ILP connector address where ILP packets are received.                                                                   |
| `KEY_ID`                        | `backend.key.id`                                                                                                                                                      | _undefined_                                                 | Your Rafiki instance’s client key ID.                                                                                       |
| `OPEN_PAYMENTS_URL`             | `backend.serviceUrls.OPEN_PAYMENTS_URL`                                                                                                                               | _undefined_                                                 | The public endpoint of your Open Payments resource server.                                                                  |
| `REDIS_URL`                     | `backend.redis.host`,<br />`backend.redis.port`                                                                                                                       | `redis://127.0.0.1:6379`                                    | The Redis URL of the database handling ILP packet data. For Helm, these components are provided individually.               |
| `USE_TIGERBEETLE`               | `backend.use.tigerbeetle`                                                                                                                                             | `true`                                                      | When `true`, a TigerBeetle database is used for accounting. When `false`, a Postgres database is used.                      |
| `WEBHOOK_URL`                   | `backend.serviceUrls.WEBHOOK_URL`                                                                                                                                     | _undefined_                                                 | Your endpoint that consumes webhook events.                                                                                 |

</div>

### Conditionally required

<div class="overflow-table">

| Variable        | Helm value name         | Default     | Description                                                                                                                                                               |
| --------------- | ----------------------- | ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `INSTANCE_NAME` | `backend.instance.name` | _undefined_ | Your Rafiki instance's name used to communicate for auto-peering and/or [telemetry](/overview/concepts/telemetry). Required when auto-peering and/or telemetry is enabled |
| `TRUST_PROXY`   | `backend.trustProxy`    | `false`     | Must be set to `true` when running Rafiki behind a proxy. When `true`, the `X-Forwarded-Proto` header is used to determine if connections are secure.                     |

</div>

### Optional

<div class="overflow-table wider-column">

| Variable                                              | Helm value name                                          | Default                                                                     | Description                                                                                                                                                                                                                                 |
| ----------------------------------------------------- | -------------------------------------------------------- | --------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `ADMIN_PORT`                                          | `backend.port.admin`                                     | `3001`                                                                      | The port of your Backend Auth API server.                                                                                                                                                                                                   |
| `ADMIN_API_SIGNATURE_TTL_SECONDS`                     | _undefined_                                              | `30`                                                                        | The TTL, in seconds, for which a request’s signature will be valid.                                                                                                                                                                         |
| `API_SECRET`                                          | _undefined_                                              | _undefined_                                                                 | N/A                                                                                                                                                                                                                                         |
| `API_SIGNATURE_VERSION`                               | _undefined_                                              | `1`                                                                         | The version of the request signing algorithm used to generate signatures.                                                                                                                                                                   |
| `AUTO_PEERING_SERVER_PORT`                            | `backend.autoPeering.serverPort`                         | `3005`                                                                      | If auto-peering is enabled, the server will use this port.                                                                                                                                                                                  |
| `CONNECTOR_PORT`                                      | `backend.port.connector`                                 | `3002`                                                                      | The port of the ILP connector for sending packets via ILP over HTTP.                                                                                                                                                                        |
| `ENABLE_AUTO_PEERING`                                 | `backend.enable.autoPeering`                             | `false`                                                                     | When `true`, auto-peering is enabled.                                                                                                                                                                                                       |
| `ENABLE_MANUAL_MIGRATIONS`                            | `backend.enableManualMigrations`                         | `false`                                                                     | When `true`, you must run the database manually with the command `npm run knex – migrate:latest –env production`                                                                                                                            |
| `ENABLE_SPSP_PAYMENT_POINTERS`                        | `backend.enable.spspPaymentPointers`                     | `true`                                                                      | When `true`, the SPSP route is enabled.                                                                                                                                                                                                     |
| `ENABLE_TELEMETRY`                                    | _undefined_                                              | `false`                                                                     | Enables the telemetry service on Rafiki.                                                                                                                                                                                                    |
| `ENABLE_TELEMETRY_TRACES`                             | _undefined_                                              | `false`                                                                     | N/A                                                                                                                                                                                                                                         |
| `EXCHANGE_RATES_LIFETIME`                             | `backend.lifetime.exchangeRate`                          | `15_000`                                                                    | The time, in milliseconds, the exchange rates you provide via the `EXCHANGE_RATES_URL` are valid.                                                                                                                                           |
| `GRAPHQL_IDEMPOTENCY_KEY_LOCK_MS`                     | `backend.idempotency.keyLockMs`                          | `2000`                                                                      | The TTL, in milliseconds, for `idempotencyKey` concurrency lock on GraphQL mutations on the Backend Admin API.                                                                                                                              |
| `GRAPHQL_IDEMPOTENCY_KEY_TTL_MS`                      | `backend.idempotency.keyTTL`                             | `86400000` (24 hours)                                                       | The TTL, in milliseconds, for `idempotencyKey` on GraphQL mutations on the Backend Admin API.                                                                                                                                               |
| `INCOMING_PAYMENT_CREATED_POLL_FREQUENCY_MS`          | _undefined_                                              | `1000`                                                                      | N/A                                                                                                                                                                                                                                         |
| `INCOMING_PAYMENT_CREATED_POLL_TIMEOUT_MS`            | _undefined_                                              | `10000`                                                                     | N/A                                                                                                                                                                                                                                         |
| `INCOMING_PAYMENT_EXPIRY_MAX_MS`                      | `backend.incomingPayment.expiryMaxMs`                    | `2592000000` (30 days)                                                      | The maximum into the future, in milliseconds, incoming payments expiry can be set to on creation.                                                                                                                                           |
| `INCOMING_PAYMENT_WORKER_IDLE`                        | `backend.workerIdle`                                     | `200`                                                                       | The time, in milliseconds, that `INCOMING_PAYMENT_WORKERS` will wait until checking an empty incoming payment request queue again.                                                                                                          |
| `INCOMING_PAYMENT_WORKERS`                            | `backend.workers.incomingPayment`                        | `1`                                                                         | The number of workers processing incoming payment requests.                                                                                                                                                                                 |
| `LOG_LEVEL`                                           | `backend.logLevel`                                       | `info`                                                                      | <LinkOut href="https://getpino.io/#/docs/api?id=levels">Pino log level</LinkOut>                                                                                                                                                            |
| `MAX_OUTGOING_PAYMENT_RETRY_ATTEMPTS`                 | _undefined_                                              | `5`                                                                         | Specifies how many times an outgoing payment is retried before failing completely                                                                                                                                                           |
| `NODE_ENVIRONMENT`                                    | `backend.nodeEnv`                                        | `development`                                                               | The type of node environment: `development`, `test`, or `production`.                                                                                                                                                                       |
| `OPEN_PAYMENTS_PORT`                                  | `backend.port.openPayments`                              | `3003`                                                                      | The port of your Open Payments resource server.                                                                                                                                                                                             |
| `OPEN_TELEMETRY_COLLECTOR_URLS`                       | _undefined_                                              | \*undefined                                                                 | N/A                                                                                                                                                                                                                                         |
| `OPEN_TELEMETRY_EXPORT_INTERVAL`                      | _undefined_                                              | `15000`                                                                     | N/A                                                                                                                                                                                                                                         |
| `OPEN_TELEMETRY_TRACE_COLLECTOR_URLS`                 | _undefined_                                              | _undefined_                                                                 | N/A                                                                                                                                                                                                                                         |
| `OUTGOING_PAYMENT_WORKER_IDLE`                        | `backend.workerIdle`                                     | `200`                                                                       | The time, in milliseconds, that `OUTGOING_PAYMENT_WORKERS` wait until they check an empty outgoing payment request queue again.                                                                                                             |
| `OUTGOING_PAYMENT_WORKERS`                            | `backend.workers.outgoingPayment`                        | `4`                                                                         | The number of workers processing outgoing payment requests.                                                                                                                                                                                 |
| `POLL_INCOMING_PAYMENT_CREATED_WEBHOOK`               | _undefined_                                              | `false`                                                                     | N/A                                                                                                                                                                                                                                         |
| `PRIVATE_KEY_FILE`                                    | `backend.key.file`                                       | _undefined_                                                                 | The path to your Rafiki instance’s client private key.                                                                                                                                                                                      |
| `QUOTE_LIFESPAN`                                      | `backend.lifetime.quote`                                 | `5 * 60_000` (5 minutes)                                                    | The time, in milliseconds, an Open Payments quote is valid for.                                                                                                                                                                             |
| `REDIS_TLS_CA_FILE_PATH`                              | `backend.redis.tlsCaFile`                                | `''`                                                                        | <LinkOut href="https://redis.io/docs/latest/operate/oss_and_stack/management/security/encryption/">Redis TLS config</LinkOut>                                                                                                               |
| `REDIS_TLS_CERT_FILE_PATH`                            | `backend.redis.tlsCertFile`                              | `''`                                                                        | <LinkOut href="https://redis.io/docs/latest/operate/oss_and_stack/management/security/encryption/">Redis TLS config</LinkOut>                                                                                                               |
| `REDIS_TLS_KEY_FILE_PATH`                             | `backend.redis.tlsKeyFile`                               | `''`                                                                        | <LinkOut href="https://redis.io/docs/latest/operate/oss_and_stack/management/security/encryption/">Redis TLS config</LinkOut>                                                                                                               |
| `SIGNATURE_SECRET`                                    | `backend.quoteSignatureSecret`                           | _undefined_                                                                 | The secret to generate request header signatures for webhook event requests.                                                                                                                                                                |
| `SIGNATURE_VERSION`                                   | `backend.signatureVersion`                               | `1`                                                                         | The version number to generate request header signatures for webhook events.                                                                                                                                                                |
| `SLIPPAGE`                                            | `backend.ilp.slippage`                                   | `0.01` (1%)                                                                 | The accepted ILP rate fluctuation.                                                                                                                                                                                                          |
| `STREAM_SECRET`                                       | `backend.ilp.streamSecret`                               | _undefined_                                                                 | The seed secret to generate shared STREAM secrets.                                                                                                                                                                                          |
| `TELEMETRY_EXCHANGE_RATES_LIFETIME`                   | _undefined_                                              | `86_400_000`                                                                | N/A                                                                                                                                                                                                                                         |
| `TELEMETRY_EXCHANGE_RATES_URL`                        | _undefined_                                              | `https://telemetry-exchange-rates.s3.amazonaws.com/exchange-rates-usd.json` | The endpoint Rafiki will query for exchange rates. Used as a fallback if/when [exchange rates](/integration/requirements/exchange-rates) aren’t provided.                                                                                   |
| `TIGERBEETLE_CLUSTER_ID`                              | _undefined_                                              | `0`                                                                         | The TigerBeetle cluster ID picked by the system that starts the TigerBeetle cluster to create a <LinkOut href="https://docs.tigerbeetle.com/clients/node/#creating-a-client">TigerBeetle client</LinkOut>.                                  |
| `TIGERBEETLE_REPLICA_ADDRESSES`                       | _undefined_                                              | `3004`                                                                      | TigerBeetle replica addresses for all replicas in the cluster. The addresses are comma-separated IP addresses/ports, to create a <LinkOut href="https://docs.tigerbeetle.com/clients/node/#creating-a-client">TigerBeetle client</LinkOut>. |
| `TIGERBEETLE_REPLICA_ADDRESSES.SPLIT`                 | _undefined_                                              | `3004`                                                                      | N/A                                                                                                                                                                                                                                         |
| `TIGERBEETLE_TWO_PHASE_TIMEOUT_SECONDS`               | _undefined_                                              | `5`                                                                         | N/A                                                                                                                                                                                                                                         |
| `WALLET_ADDRESS_DEACTIVATION_PAYMENT_GRACE_PERIOD_MS` | `backend.walletAddress.deactivationPaymentGratePeriodMs` | `86400000` (24 hours)                                                       | The time into the future, in milliseconds, to set expiration of Open Payments incoming payments when deactivating a wallet address.                                                                                                         |
| `WALLET_ADDRESS_LOOKUP_TIMEOUT_MS`                    | `backend.walletAddress.lookupTimeoutMs`                  | `1500`                                                                      | The time, in milliseconds, you have to create a missing wallet address before timeout.                                                                                                                                                      |
| `WALLET_ADDRESS_POLLING_FREQUENCY_MS`                 | `backend.walletAddress.pollingFrequencyMs`               | `100`                                                                       | The frequency of polling while waiting for you to create a missing wallet address.                                                                                                                                                          |
| `WALLET_ADDRESS_URL`                                  | `backend.serviceUrls.WALLET_ADDRESS_URL`                 | `http://127.0.0.1:3001/.well-known/pay`                                     | Your Rafiki instance’s internal wallet address.                                                                                                                                                                                             |
| `WALLET_ADDRESS_WORKER_IDLE`                          | `backend.workerIdle`                                     | `200`                                                                       | The time, in milliseconds, that `WALLET_ADDRESS_WORKERS` wait until checking the empty wallet address request queue again.                                                                                                                  |
| `WALLET_ADDRESS_WORKERS`                              | `backend.workers.walletAddress                           | `1`                                                                         | The number of workers processing wallet address requests.                                                                                                                                                                                   |
| `WEBHOOK_MAX_RETRY`                                   | `backend.webhookMaxRetry`                                | `10`                                                                        | The maximum number of times your Rafiki instance’s backend retries sending a certain webhook event to your configured `WEBHOOK_URL`.                                                                                                        |
| `WEBHOOK_TIMEOUT`                                     | `backend.lifetime.webhook`                               | `2000` (2 seconds)                                                          | The time, in milliseconds, that your Rafiki instance will wait for a `200` response from your webhook endpoint. If a `200` response is not received, Rafiki will time out and try to send the webhook event again.                          |
| `WEBHOOK_WORKER_IDLE`                                 | `backend.workerIdle`                                     | `200`                                                                       | The time, in milliseconds, that `WEBHOOK_WORKERS` will wait until they check the empty webhook event queue again.                                                                                                                           |
| `WEBHOOK_WORKERS`                                     | `backend.workers.webhook`                                | `1`                                                                         | The number of workers processing webhook events.                                                                                                                                                                                            |
| `WITHDRAWAL_THROTTLE_DELAY`                           | `backend.withdrawalThrottleDelay`                        | _undefined_                                                                 | The delay in liquidity withdrawal processing.                                                                                                                                                                                               |

</div>
