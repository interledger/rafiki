---
title: Rafiki-deployment-testnet
---

### Table of Contents
1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Architecture Overview](#architecture-overview)
4. [Infrastructure Setup with Terraform](#infrastructure-setup-with-terraform)
5. [Kubernetes Deployment](#kubernetes-deployment)
6. [Rafiki Configuration](#rafiki-configuration)
7. [Security Considerations](#security-considerations)
8. [Monitoring and Observability](#monitoring-and-observability)
9. [Testing and Validation](#testing-and-validation)
10. [Production Deployment](#production-deployment)
11. [Maintenance and Operations](#maintenance-and-operations)

---

## Overview

Rafiki is open source software that provides an efficient solution for an Account Servicing Entity to enable Interledger functionality on its users' accounts. This guide provides a comprehensive deployment strategy for financial institutions looking to integrate Rafiki into their existing infrastructure using modern cloud-native technologies.

**Key Components:**
- **Rafiki Backend**: Includes an Interledger connector, a high-throughput accounting database called TigerBeetle, and several APIs
- **Open Payments API**: For third-party payment initiation
- **Admin APIs**: For managing peering relationships and supported assets
- **GNAP Authorization Server**: Access control for Open Payments API

---

## Prerequisites

### Technical Requirements
- **Google Cloud Platform Account** with billing enabled
- **Terraform** >= 1.0
- **Helm** >= 3.7.2
- **kubectl** >= 1.20
- **Docker** for local development
- **Git** for version control

### Financial Institution Requirements
- **Regulatory Compliance**: Ensure compliance with local financial regulations
- **KYC/AML Processes**: Integration with existing compliance systems
- **Risk Management**: Established risk assessment frameworks
- **Security Policies**: Enterprise-grade security protocols

### Domain and DNS
- Registered domain for your institution
- SSL/TLS certificates (Let's Encrypt or commercial)
- DNS management access

---

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                     Google Cloud Platform                       │
├─────────────────────────────────────────────────────────────────┤
│                         GKE Cluster                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Rafiki        │  │   TigerBeetle   │  │   PostgreSQL    │  │
│  │   Backend       │  │   Accounting    │  │   Auth DB       │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Auth Server   │  │   Redis Cache   │  │   Monitoring    │  │
│  │   (GNAP)        │  │                 │  │   Stack         │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                     Supporting Services                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Cloud SQL     │  │   Cloud Storage │  │   Cloud KMS     │  │
│  │   (Backup)      │  │   (Artifacts)   │  │   (Secrets)     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Infrastructure Setup with Terraform

### Project Structure

```
rafiki-infrastructure/
├── environments/
│   ├── dev/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── terraform.tfvars
│   ├── staging/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── terraform.tfvars
│   └── prod/
│       ├── main.tf
│       ├── variables.tf
│       └── terraform.tfvars
├── modules/
│   ├── gke/
│   ├── networking/
│   ├── security/
│   └── storage/
├── helm-charts/
└── scripts/
```

### Core Terraform Configuration

#### 1. Provider Configuration (`providers.tf`)

```hcl
terraform {
  required_version = ">= 1.0"
  required_providers {
    google = {
      source  = "hashicorp/google"
      version = "~> 4.0"
    }
    google-beta = {
      source  = "hashicorp/google-beta"
      version = "~> 4.0"
    }
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = "~> 2.0"
    }
    helm = {
      source  = "hashicorp/helm"
      version = "~> 2.0"
    }
  }
  
  backend "gcs" {
    bucket = "your-bank-terraform-state"
    prefix = "rafiki/terraform.tfstate"
  }
}

provider "google" {
  project = var.project_id
  region  = var.region
  zone    = var.zone
}

provider "google-beta" {
  project = var.project_id
  region  = var.region
  zone    = var.zone
}

data "google_client_config" "default" {}

provider "kubernetes" {
  host                   = "https://${module.gke.endpoint}"
  token                  = data.google_client_config.default.access_token
  cluster_ca_certificate = base64decode(module.gke.ca_certificate)
}

provider "helm" {
  kubernetes {
    host                   = "https://${module.gke.endpoint}"
    token                  = data.google_client_config.default.access_token
    cluster_ca_certificate = base64decode(module.gke.ca_certificate)
  }
}
```

#### 2. Variables Configuration (`variables.tf`)

```hcl
variable "project_id" {
  description = "GCP Project ID"
  type        = string
}

variable "region" {
  description = "GCP Region"
  type        = string
  default     = "us-central1"
}

variable "zone" {
  description = "GCP Zone"
  type        = string
  default     = "us-central1-a"
}

variable "environment" {
  description = "Environment name (dev, staging, prod)"
  type        = string
}

variable "organization_name" {
  description = "Your bank or financial institution name"
  type        = string
}

variable "domain_name" {
  description = "Your institution's domain name"
  type        = string
}

variable "gke_node_count" {
  description = "Number of GKE nodes"
  type        = number
  default     = 3
}

variable "gke_machine_type" {
  description = "GKE node machine type"
  type        = string
  default     = "e2-standard-4"
}

variable "enable_tigerbeetle" {
  description = "Enable TigerBeetle for high-performance accounting"
  type        = bool
  default     = true
}
```

#### 3. Main Infrastructure (`main.tf`)

```hcl
locals {
  name_prefix = "${var.organization_name}-rafiki-${var.environment}"
  common_labels = {
    environment    = var.environment
    organization   = var.organization_name
    managed_by     = "terraform"
    application    = "rafiki"
  }
}

# VPC Network
module "networking" {
  source = "./modules/networking"
  
  name_prefix    = local.name_prefix
  project_id     = var.project_id
  region         = var.region
  common_labels  = local.common_labels
}

# GKE Cluster
module "gke" {
  source = "./modules/gke"
  
  name_prefix         = local.name_prefix
  project_id          = var.project_id
  region              = var.region
  zone                = var.zone
  network_name        = module.networking.network_name
  subnet_name         = module.networking.subnet_name
  node_count          = var.gke_node_count
  machine_type        = var.gke_machine_type
  common_labels       = local.common_labels
}

# Cloud SQL for PostgreSQL (Auth services)
module "postgresql" {
  source = "./modules/storage"
  
  name_prefix    = local.name_prefix
  project_id     = var.project_id
  region         = var.region
  network_id     = module.networking.network_id
  database_name  = "rafiki_auth"
  common_labels  = local.common_labels
}

# Security and Secrets Management
module "security" {
  source = "./modules/security"
  
  name_prefix   = local.name_prefix
  project_id    = var.project_id
  region        = var.region
  common_labels = local.common_labels
}

# DNS and SSL
resource "google_dns_managed_zone" "rafiki_zone" {
  name        = "${replace(local.name_prefix, "-", "")}zone"
  dns_name    = "${var.environment}.${var.domain_name}."
  description = "DNS zone for Rafiki ${var.environment} environment"
  
  labels = local.common_labels
}

# Static IP for Load Balancer
resource "google_compute_global_address" "rafiki_ip" {
  name         = "${local.name_prefix}-ip"
  ip_version   = "IPV4"
  address_type = "EXTERNAL"
}
```

### GKE Module (`modules/gke/main.tf`)

```hcl
resource "google_container_cluster" "rafiki_cluster" {
  name     = "${var.name_prefix}-cluster"
  location = var.region
  
  # Enable Workload Identity
  workload_identity_config {
    workload_pool = "${var.project_id}.svc.id.goog"
  }
  
  # Network configuration
  network    = var.network_name
  subnetwork = var.subnet_name
  
  # Security configuration
  enable_shielded_nodes = true
  
  # Remove default node pool
  remove_default_node_pool = true
  initial_node_count       = 1
  
  # Addons
  addons_config {
    network_policy_config {
      disabled = false
    }
    
    horizontal_pod_autoscaling {
      disabled = false
    }
    
    istio_config {
      disabled = false
      auth     = "AUTH_MUTUAL_TLS"
    }
  }
  
  # Enable network policy
  network_policy {
    enabled = true
  }
  
  # Private cluster configuration for production
  private_cluster_config {
    enable_private_nodes    = true
    enable_private_endpoint = false
    master_ipv4_cidr_block  = "172.16.0.0/28"
  }
  
  # IP allocation policy
  ip_allocation_policy {
    cluster_secondary_range_name  = "gke-pods"
    services_secondary_range_name = "gke-services"
  }
  
  master_auth {
    client_certificate_config {
      issue_client_certificate = false
    }
  }
}

resource "google_container_node_pool" "rafiki_nodes" {
  name       = "${var.name_prefix}-node-pool"
  location   = var.region
  cluster    = google_container_cluster.rafiki_cluster.name
  node_count = var.node_count
  
  # Auto-scaling configuration
  autoscaling {
    min_node_count = 1
    max_node_count = 10
  }
  
  # Node configuration
  node_config {
    preemptible  = var.environment != "prod"
    machine_type = var.machine_type
    disk_size_gb = 100
    disk_type    = "pd-ssd"
    
    # Security
    shielded_instance_config {
      enable_secure_boot          = true
      enable_integrity_monitoring = true
    }
    
    # Service account
    service_account = google_service_account.gke_nodes.email
    oauth_scopes = [
      "https://www.googleapis.com/auth/logging.write",
      "https://www.googleapis.com/auth/monitoring",
      "https://www.googleapis.com/auth/devstorage.read_only",
    ]
    
    # Labels
    labels = var.common_labels
  }
  
  # Update strategy
  management {
    auto_repair  = true
    auto_upgrade = true
  }
}

resource "google_service_account" "gke_nodes" {
  account_id   = "${var.name_prefix}-gke-nodes"
  display_name = "GKE Nodes Service Account"
}
```

---

## Kubernetes Deployment

### Namespace and RBAC

```yaml
# k8s/namespaces.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: rafiki-system
  labels:
    name: rafiki-system
    istio-injection: enabled
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rafiki-backend
  namespace: rafiki-system
  annotations:
    iam.gke.io/gcp-service-account: rafiki-backend@PROJECT_ID.iam.gserviceaccount.com
```

### Using Interledger Helm Charts

Add the Interledger Helm repository:

```bash
# Add the Interledger Helm repository
helm repo add interledger https://interledger.github.io/helm-charts
helm repo update

# Search available charts
helm search repo interledger
```

### Rafiki Configuration Values

Create a `values-production.yaml` file:

```yaml
# values-production.yaml
rafiki:
  backend:
    image:
      repository: interledger/rafiki
      tag: "latest"
      pullPolicy: IfNotPresent
    
    replicaCount: 3
    
    env:
      # Database Configuration
      DATABASE_URL: "postgresql://rafiki:password@postgresql:5432/rafiki_auth"
      
      # TigerBeetle Configuration (if enabled)
      TIGERBEETLE_CLUSTER_ID: "0"
      TIGERBEETLE_REPLICA_ADDRESSES: "tigerbeetle:3000"
      
      # Open Payments Configuration
      OPEN_PAYMENTS_URL: "https://rafiki.yourdomain.com"
      
      # Interledger Configuration
      ILP_ADDRESS: "g.yourdomain"
      ILP_CONNECTOR_ADDRESS: "0.0.0.0:4000"
      
      # Auth Configuration
      AUTH_SERVER_GRANT_URL: "https://auth.yourdomain.com"
      AUTH_SERVER_INTROSPECTION_URL: "https://auth.yourdomain.com/introspect"
      
      # Redis Configuration
      REDIS_URL: "redis://redis:6379"
      
      # Logging
      LOG_LEVEL: "info"
      
    resources:
      requests:
        memory: "512Mi"
        cpu: "500m"
      limits:
        memory: "2Gi"
        cpu: "2000m"
    
    service:
      type: ClusterIP
      port: 3001
      
    ingress:
      enabled: true
      className: "nginx"
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
      hosts:
        - host: rafiki.yourdomain.com
          paths:
            - path: /
              pathType: Prefix
      tls:
        - secretName: rafiki-tls
          hosts:
            - rafiki.yourdomain.com

# TigerBeetle Configuration
tigerbeetle:
  enabled: true
  replicaCount: 3
  
  image:
    repository: tigerbeetle/tigerbeetle
    tag: "latest"
    pullPolicy: IfNotPresent
  
  persistence:
    enabled: true
    storageClass: "ssd"
    size: 100Gi
  
  resources:
    requests:
      memory: "1Gi"
      cpu: "1000m"
    limits:
      memory: "4Gi"
      cpu: "4000m"

# PostgreSQL Configuration
postgresql:
  enabled: true
  
  auth:
    username: rafiki
    database: rafiki_auth
    existingSecret: rafiki-db-secret
    
  primary:
    persistence:
      enabled: true
      storageClass: "ssd"
      size: 50Gi
    
    resources:
      requests:
        memory: "512Mi"
        cpu: "500m"
      limits:
        memory: "2Gi"
        cpu: "2000m"

# Redis Configuration
redis:
  enabled: true
  
  auth:
    enabled: true
    existingSecret: redis-secret
    
  master:
    persistence:
      enabled: true
      storageClass: "ssd"
      size: 20Gi

# Auth Server Configuration
authServer:
  enabled: true
  
  image:
    repository: interledger/rafiki-auth
    tag: "latest"
    
  replicaCount: 2
  
  env:
    DATABASE_URL: "postgresql://rafiki:password@postgresql:5432/rafiki_auth"
    IDENTITY_SERVER_URL: "https://auth.yourdomain.com"
    
  service:
    type: ClusterIP
    port: 3006
    
  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
    hosts:
      - host: auth.yourdomain.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: auth-tls
        hosts:
          - auth.yourdomain.com

# Monitoring Configuration
monitoring:
  prometheus:
    enabled: true
  grafana:
    enabled: true
    adminPassword: "secure-password"
  
# Security
securityContext:
  runAsNonRoot: true
  runAsUser: 1001
  fsGroup: 1001

# Network Policies
networkPolicy:
  enabled: true
```

---

## Security Considerations

### 1. Secrets Management

```bash
# Create required secrets
kubectl create secret generic rafiki-db-secret \
  --from-literal=username=rafiki \
  --from-literal=password=your-secure-password \
  -n rafiki-system

kubectl create secret generic redis-secret \
  --from-literal=redis-password=your-redis-password \
  -n rafiki-system

# TLS Certificates (using cert-manager)
kubectl apply -f - <<EOF
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@yourdomain.com
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx
EOF
```

### 2. Network Security

```yaml
# Network Policy for Rafiki Backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: rafiki-backend-netpol
  namespace: rafiki-system
spec:
  podSelector:
    matchLabels:
      app: rafiki-backend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3001
  - from:
    - podSelector:
        matchLabels:
          app: rafiki-auth
    ports:
    - protocol: TCP
      port: 3001
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: postgresql
    ports:
    - protocol: TCP
      port: 5432
  - to:
    - podSelector:
        matchLabels:
          app: tigerbeetle
    ports:
    - protocol: TCP
      port: 3000
  - to: []
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
```

### 3. Pod Security Standards

```yaml
# Pod Security Policy
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: rafiki-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
```

---

## Monitoring and Observability

### Prometheus Configuration

```yaml
# prometheus-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: rafiki-system
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    scrape_configs:
    - job_name: 'rafiki-backend'
      static_configs:
      - targets: ['rafiki-backend:3001']
      metrics_path: '/metrics'
      
    - job_name: 'tigerbeetle'
      static_configs:
      - targets: ['tigerbeetle:3000']
      metrics_path: '/metrics'
      
    - job_name: 'postgresql'
      static_configs:
      - targets: ['postgresql-exporter:9187']
      
    - job_name: 'kubernetes-pods'
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
```

### Grafana Dashboards

Key metrics to monitor:
- **Transaction throughput** and latency
- **Account balance consistency**
- **API response times**
- **Database performance**
- **Pod resource utilization**
- **Network connectivity**

---

## Testing and Validation

### 1. Testnet Integration

Test Network is an open Interledger network working with test money designed for account servicing entities to test their Interledger integration.

```bash
# Deploy to testnet environment first
helm install rafiki-testnet interledger/rafiki \
  -f values-testnet.yaml \
  -n rafiki-testnet \
  --create-namespace
```

### 2. Integration Tests

```bash
#!/bin/bash
# test-rafiki-integration.sh

# Test basic connectivity
kubectl exec -n rafiki-system deployment/rafiki-backend -- \
  curl -f http://localhost:3001/health

# Test database connectivity
kubectl exec -n rafiki-system deployment/rafiki-backend -- \
  psql $DATABASE_URL -c "SELECT 1"

# Test TigerBeetle connection
kubectl exec -n rafiki-system deployment/tigerbeetle -- \
  tigerbeetle version

# Test Open Payments API
curl -X GET https://rafiki.yourdomain.com/.well-known/open_payments_authz

# Test admin API
curl -X POST https://rafiki.yourdomain.com/graphql \
  -H "Content-Type: application/json" \
  -d '{"query": "query { assets { edges { node { id code } } } }"}'
```

### 3. Load Testing

```javascript
// k6 load test script
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  stages: [
    { duration: '2m', target: 100 },
    { duration: '5m', target: 100 },
    { duration: '2m', target: 200 },
    { duration: '5m', target: 200 },
    { duration: '2m', target: 0 },
  ],
};

export default function() {
  let response = http.get('https://rafiki.yourdomain.com/health');
  check(response, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });
}
```

---

## Production Deployment

### Pre-deployment Checklist

- [ ] **Security Review**: Penetration testing completed
- [ ] **Compliance Verification**: Regulatory requirements met
- [ ] **Backup Strategy**: Database and configuration backups configured
- [ ] **Disaster Recovery**: Recovery procedures documented and tested
- [ ] **Monitoring**: All alerts and dashboards configured
- [ ] **Performance Testing**: Load testing completed successfully
- [ ] **Documentation**: Operational runbooks completed

### Deployment Steps

```bash
# 1. Deploy infrastructure
cd environments/prod
terraform init
terraform plan -var-file=terraform.tfvars
terraform apply

# 2. Configure kubectl
gcloud container clusters get-credentials rafiki-prod-cluster \
  --region us-central1 \
  --project your-project-id

# 3. Install cert-manager
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.11.0/cert-manager.yaml

# 4. Install ingress controller
helm upgrade --install ingress-nginx ingress-nginx \
  --repo https://kubernetes.github.io/ingress-nginx \
  --namespace ingress-nginx \
  --create-namespace

# 5. Deploy Rafiki
helm upgrade --install rafiki interledger/rafiki \
  -f values-production.yaml \
  -n rafiki-system \
  --create-namespace \
  --wait

# 6. Verify deployment
kubectl get pods -n rafiki-system
kubectl get ingress -n rafiki-system
```

### Post-deployment Validation

```bash
# Health checks
curl -f https://rafiki.yourdomain.com/health
curl -f https://auth.yourdomain.com/health

# Admin API test
curl -X POST https://rafiki.yourdomain.com/graphql \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -d '{"query": "query { peers { edges { node { id staticIlpAddress } } } }"}'

# Open Payments discovery
curl https://rafiki.yourdomain.com/.well-known/open_payments_authz
```

---

## Maintenance and Operations

### Regular Maintenance Tasks

1. **Weekly**:
   - Review monitoring dashboards
   - Check security alerts
   - Verify backup integrity

2. **Monthly**:
   - Update Helm charts
   - Review resource utilization
   - Security patch updates

3. **Quarterly**:
   - Disaster recovery testing
   - Security audit
   - Performance optimization review

### Backup and Recovery

```bash
# Database backup script
#!/bin/bash
BACKUP_NAME="rafiki-backup-$(date +%Y%m%d-%H%M%S)"

# Create database backup
kubectl exec -n rafiki-system deployment/postgresql -- \
  pg_dump -U rafiki rafiki_auth > $BACKUP_NAME.sql

# Upload to Cloud Storage
gsutil cp $BACKUP_NAME.sql gs://your-backup-bucket/
```

### Scaling Considerations

- **Horizontal Pod Autoscaling**: Configure HPA for backend services
- **Vertical Pod Autoscaling**: Optimize resource requests/limits
- **Database Scaling**: Consider read replicas for high-read workloads
- **TigerBeetle Scaling**: TigerBeetle is optimized for online transaction processing (OLTP) workloads, offering significantly higher performance

### Troubleshooting Guide

Common issues and solutions:

1. **Pod Startup Issues**:
   ```bash
   kubectl describe pod -n rafiki-system
   kubectl logs -f deployment/rafiki-backend -n rafiki-system
   ```

2. **Database Connection Issues**:
   ```bash
   kubectl exec -n rafiki-system deployment/rafiki-backend -- \
     nc -zv postgresql 5432
   ```

3. **TLS Certificate Issues**:
   ```bash
   kubectl describe certificate -n rafiki-system
   kubectl describe certificaterequest -n rafiki-system
   ```

---

## Conclusion

This guide provides a comprehensive foundation for deploying Rafiki in a production environment. By harnessing TigerBeetle's advanced features, Rafiki offers Account Servicing Entities (ASEs) a powerful and dependable solution for implementing Interledger functionality.

Key success factors:
- **Security-first approach** with proper secrets management
- **Scalable architecture** using Kubernetes best practices
- **Comprehensive monitoring** for operational excellence
- **Automated deployment** with Terraform and Helm
- **Compliance readiness** for financial regulations

For additional support and community resources, visit the [Interledger Community](https://community.interledger.org/) and the [Rafiki GitHub repository](https://github.com/interledger/rafiki).
